require 'socket'
require 'timeout'

class Connect
  def initialize(host)
    @host = host
  end
  
  def check
    result = Hash.new
    #host = @host.select { |h| h.match(/(\d+(\.|:)){4}/) }
    host = @host.scan(/((\d\d?\d?(\.|:)){4}\d{1,5})/)
    host.each do |h|
      ip, port = h[0].split(":") #split the string to get the ip and the port
      begin
        Timeout::timeout(5) do #5 seconds should be enough to determine whether the destination will connect
          begin
            target = TCPSocket.new(ip, port) #create a socket connection out of the ip and the port
            target.close
            result[h[0]] = true
          rescue Errno::ECONNREFUSED, Errno::EHOSTUNREACH #false if failed to connect
            result[h[0]] = false
          end
        end
        result[h[0]] = false if ! result.has_key? h[0] #timed out
      end
    end
    return result
  end
end
